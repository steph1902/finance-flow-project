// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MODEL
// ============================================
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // Hashed password (null if OAuth)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // User preferences
  preferredCurrency String   @default("USD")
  timezone          String   @default("UTC")
  language          String   @default("en")
  
  // Onboarding status
  onboardingCompleted Boolean @default(false)
  onboardingStep      Int     @default(0)

  // Relations
  accounts              Account[]
  sessions              Session[]
  transactions          Transaction[]
  budgets               Budget[]
  aiSuggestions         AISuggestion[]
  aiChatHistory         AIChatHistory[]
  recurringTransactions RecurringTransaction[]
  goals                 Goal[]
  notifications         Notification[]
  sharedBudgets         SharedBudget[]
  budgetPermissions     BudgetPermission[]
  reports               Report[]
  investments           Investment[]
  
  // Phase 4: Decision Intelligence
  financialSnapshots    FinancialSnapshot[]
  big4Analyses          Big4Analysis[]

  @@map("users")
}

// ============================================
// TRANSACTION MODEL
// ============================================
enum TransactionType {
  INCOME
  EXPENSE
}

model Transaction {
  id          String          @id @default(cuid())
  userId      String
  amount      Decimal         @db.Decimal(10, 2)
  type        TransactionType
  category    String
  description String?
  notes       String?         @db.Text
  date        DateTime        @default(now())
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  deletedAt   DateTime?       // Soft delete

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId])
  @@index([date])
  @@index([type])
  @@index([category])
  @@map("transactions")
}

// ============================================
// BUDGET MODEL
// ============================================
model Budget {
  id        String   @id @default(cuid())
  userId    String
  category  String
  amount    Decimal  @db.Decimal(10, 2)
  spent     Decimal  @db.Decimal(10, 2) @default(0)
  month     Int      // 1-12
  year      Int
  rollover  Boolean  @default(false)
  alertThreshold Decimal? @db.Decimal(5, 2) // Alert when spending reaches this percentage
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Unique constraint (one budget per category per month per user)
  @@unique([userId, category, month, year])
  @@index([userId])
  @@map("budgets")
}

// ============================================
// NEXTAUTH MODELS
// ============================================
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}
// ============================================
// AI MODELS
// ============================================
model AISuggestion {
  id              String    @id @default(cuid())
  userId          String
  transactionId   String?
  suggestionType  String
  suggestedValue  String    @db.Text
  confidenceScore Decimal?  @db.Decimal(3, 2)
  accepted        Boolean?
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([transactionId])
  @@index([createdAt])
  @@map("ai_suggestions")
}

// Category Keywords (learned from user feedback)
model CategoryKeyword {
  id          String   @id @default(cuid())
  keyword     String   // Extracted keyword (lowercase)
  category    String   // Associated category
  occurrences Int      @default(1) // Number of times seen
  confidence  Decimal  @default(0.5) @db.Decimal(3, 2) // 0.00 to 1.00
  source      String   @default("user_feedback") // "user_feedback" or "manual"
  lastSeen    DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([keyword, category]) // One entry per keyword-category pair
  @@index([keyword])
  @@index([category])
  @@index([confidence])
  @@map("category_keywords")
}

model AIChatHistory {
  id             String   @id @default(uuid()) @map("id")
  userId         String   @map("user_id")
  conversationId String   @map("session_id")
  role           String   @map("message_type")
  message        String   @db.Text @map("content")
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([conversationId])
  @@map("ai_chat_history")
}

// ============================================
// RECURRING TRANSACTIONS
// ============================================
enum RecurringFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

model RecurringTransaction {
  id          String              @id @default(cuid())
  userId      String
  amount      Decimal             @db.Decimal(10, 2)
  type        TransactionType
  category    String
  description String?
  notes       String?             @db.Text
  frequency   RecurringFrequency
  startDate   DateTime
  endDate     DateTime?
  nextDate    DateTime
  isActive    Boolean             @default(true)
  lastGenerated DateTime?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([nextDate])
  @@index([isActive])
  @@map("recurring_transactions")
}

// ============================================
// ANALYTICS MODEL
// ============================================
model AnalyticsEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  
  // Session & User Info
  userId      String?
  sessionId   String
  isDemo      Boolean @default(false)
  
  // Event Details
  eventType   String  // 'login', 'page_view', 'transaction_create', 'budget_optimize', etc.
  eventName   String
  metadata    Json?   // Additional event-specific data
  
  // Navigation/Page Info
  page        String?
  referrer    String?
  userAgent   String?
  
  // Geolocation (IP-based)
  ipAddress   String?
  country     String?
  city        String?
  region      String?
  timezone    String?
  
  @@map("analytics_events")
  @@index([userId])
  @@index([sessionId])
  @@index([eventType])
  @@index([createdAt])
  @@index([isDemo])
}

// ============================================
// GOALS & SAVINGS MODEL
// ============================================
enum GoalStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  PAUSED
}

model Goal {
  id             String     @id @default(cuid())
  userId         String
  name           String
  description    String?    @db.Text
  targetAmount   Decimal    @db.Decimal(12, 2)
  currentAmount  Decimal    @db.Decimal(12, 2) @default(0)
  targetDate     DateTime?
  category       String     @default("General")
  status         GoalStatus @default(ACTIVE)
  priority       Int        @default(0) // 0 = low, 1 = medium, 2 = high
  reminderEnabled Boolean   @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  completedAt    DateTime?

  // Relations
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  milestones     GoalMilestone[]
  contributions  GoalContribution[]

  @@index([userId])
  @@index([status])
  @@index([targetDate])
  @@map("goals")
}

model GoalMilestone {
  id          String   @id @default(cuid())
  goalId      String
  amount      Decimal  @db.Decimal(12, 2)
  description String?
  achievedAt  DateTime?
  createdAt   DateTime @default(now())

  // Relations
  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@map("goal_milestones")
}

model GoalContribution {
  id        String   @id @default(cuid())
  goalId    String
  amount    Decimal  @db.Decimal(12, 2)
  notes     String?  @db.Text
  createdAt DateTime @default(now())

  // Relations
  goal Goal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId])
  @@map("goal_contributions")
}

// ============================================
// NOTIFICATIONS MODEL
// ============================================
enum NotificationType {
  BUDGET_ALERT
  BILL_REMINDER
  GOAL_MILESTONE
  ANOMALY_DETECTION
  SUBSCRIPTION_RENEWAL
  SYSTEM
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

model Notification {
  id          String             @id @default(cuid())
  userId      String
  type        NotificationType
  title       String
  message     String             @db.Text
  status      NotificationStatus @default(UNREAD)
  priority    Int                @default(0) // 0 = low, 1 = medium, 2 = high
  metadata    Json               @default("{}")
  actionUrl   String?
  sentAt      DateTime           @default(now())
  readAt      DateTime?
  archivedAt  DateTime?
  createdAt   DateTime           @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([sentAt])
  @@map("notifications")
}

// ============================================
// SHARED BUDGETS MODEL
// ============================================
model SharedBudget {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  ownerId     String
  category    String
  amount      Decimal  @db.Decimal(10, 2)
  month       Int      // 1-12
  year        Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  owner       User               @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  permissions BudgetPermission[]

  @@index([ownerId])
  @@index([month, year])
  @@map("shared_budgets")
}

enum BudgetPermissionRole {
  VIEWER
  CONTRIBUTOR
  ADMIN
}

model BudgetPermission {
  id            String               @id @default(cuid())
  sharedBudgetId String
  userId        String
  role          BudgetPermissionRole @default(VIEWER)
  canEdit       Boolean              @default(false)
  canDelete     Boolean              @default(false)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  // Relations
  sharedBudget SharedBudget @relation(fields: [sharedBudgetId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sharedBudgetId, userId])
  @@index([userId])
  @@map("budget_permissions")
}

// ============================================
// REPORTS MODEL
// ============================================
enum ReportType {
  MONTHLY
  YEARLY
  CATEGORY
  TAX
  CUSTOM
}

enum ReportFormat {
  JSON
  CSV
  PDF
}

model Report {
  id          String       @id @default(cuid())
  userId      String
  type        ReportType
  format      ReportFormat @default(JSON)
  name        String
  description String?      @db.Text
  startDate   DateTime
  endDate     DateTime
  filters     Json         @default("{}")
  data        Json         @default("{}")
  fileUrl     String?
  generatedAt DateTime     @default(now())
  expiresAt   DateTime?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([generatedAt])
  @@map("reports")
}

// ============================================
// MULTI-CURRENCY MODEL
// ============================================
model CurrencyRate {
  id           String   @id @default(cuid())
  fromCurrency String   // ISO 4217 code (e.g., USD)
  toCurrency   String   // ISO 4217 code (e.g., EUR)
  rate         Decimal  @db.Decimal(18, 8)
  date         DateTime @default(now())
  source       String   @default("fixer.io") // API source
  createdAt    DateTime @default(now())

  @@unique([fromCurrency, toCurrency, date])
  @@index([fromCurrency, toCurrency])
  @@index([date])
  @@map("currency_rates")
}

// ============================================
// SYSTEM LOGS MODEL
// ============================================
enum LogLevel {
  INFO
  WARN
  ERROR
  DEBUG
}

enum LogCategory {
  API
  AUTH
  SYSTEM
  UI
  DB
}

model SystemLog {
  id        String      @id @default(cuid())
  level     LogLevel
  category  LogCategory
  message   String      @db.Text
  metadata  Json        @default("{}")
  timestamp DateTime    @default(now())

  @@index([level])
  @@index([category])
  @@index([timestamp])
  @@map("system_logs")
}

// ============================================
// PROJECT VERSIONING MODEL
// ============================================
model ProjectVersion {
  id          String   @id @default(cuid())
  version     String   @unique // e.g., "1.2.0"
  changelog   String   @db.Text
  deployer    String   // Name or ID of who deployed
  environment String   @default("production")
  isCurrent   Boolean  @default(false)
  deployedAt  DateTime @default(now())

  @@index([deployedAt])
  @@map("project_versions")
}

// ============================================
// VISITOR FEEDBACK MODEL
// ============================================
model VisitorFeedback {
  id        String   @id @default(cuid())
  name      String
  email     String
  message   String   @db.Text
  rating    Int      @default(0) // 1-5 stars
  status    String   @default("PENDING") // PENDING, REVIEWED, ARCHIVED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("visitor_feedback")
}

// ============================================
// ENHANCED AI MODELS
// ============================================
model AIConversation {
  id          String   @id @default(cuid())
  userId      String
  title       String?
  summary     String?  @db.Text
  lastMessage DateTime @default(now())
  messageCount Int     @default(0)
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([lastMessage])
  @@map("ai_conversations")
}

model MerchantData {
  id          String   @id @default(cuid())
  name        String   @unique
  category    String
  logo        String?
  aliases     String[] // Common variations of the merchant name
  confidence  Decimal  @db.Decimal(3, 2) @default(1.0)
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@index([category])
  @@map("merchant_data")
}

// ============================================
// PLAID INTEGRATION (Optional)
// ============================================
model PlaidItem {
  id              String   @id @default(cuid())
  userId          String
  itemId          String   @unique
  accessToken     String   @db.Text // Encrypted
  institutionId   String
  institutionName String
  isActive        Boolean  @default(true)
  lastSync        DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@map("plaid_items")
}

// ============================================
// INVESTMENT TRACKING
// ============================================
enum InvestmentType {
  STOCK
  BOND
  MUTUAL_FUND
  ETF
  CRYPTO
  REAL_ESTATE
  COMMODITY
  OTHER
}

model Investment {
  id              String         @id @default(cuid())
  userId          String
  symbol          String         // Stock ticker, crypto symbol, etc.
  name            String
  type            InvestmentType
  quantity        Decimal        @db.Decimal(18, 8)
  costBasis       Decimal        @db.Decimal(12, 2) // Total amount invested
  currentValue    Decimal        @db.Decimal(12, 2) @default(0)
  currency        String         @default("USD")
  notes           String?        @db.Text
  purchaseDate    DateTime
  lastUpdated     DateTime       @default(now())
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions    InvestmentTransaction[]

  @@index([userId])
  @@index([symbol])
  @@index([type])
  @@map("investments")
}

enum InvestmentTransactionType {
  BUY
  SELL
  DIVIDEND
  INTEREST
  FEE
  SPLIT
}

model InvestmentTransaction {
  id            String                    @id @default(cuid())
  investmentId  String
  type          InvestmentTransactionType
  quantity      Decimal                   @db.Decimal(18, 8)
  price         Decimal                   @db.Decimal(12, 2)
  totalAmount   Decimal                   @db.Decimal(12, 2)
  fees          Decimal                   @db.Decimal(10, 2) @default(0)
  date          DateTime
  notes         String?                   @db.Text
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt

  // Relations
  investment Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  @@index([investmentId])
  @@index([date])
  @@map("investment_transactions")
}

// ============================================
// AUTONOMOUS AGENT SYSTEM
// ============================================

model AgentDecisionLog {
  id                String   @id @default(cuid())
  agentType         String   // 'BudgetGuardian', 'ClassificationAgent', etc.
  
  // Decision cycle data
  observation       Json     // What the agent saw
  insights          Json     // What patterns it detected
  actions           Json     // What actions it decided to take
  reasoning         String   @db.Text // Why it made those decisions
  
  // Execution metadata
  executionTimeMs   Int?     // How long the cycle took
  insightsCount     Int      @default(0)
  actionsCount      Int      @default(0)
  highSeverityCount Int      @default(0)
  
  // Timestamps
  timestamp         DateTime @default(now())
  createdAt         DateTime @default(now())
  
  @@index([agentType])
  @@index([timestamp])
  @@index([highSeverityCount])
  @@map("agent_decision_logs")
}

model AgentFeedback {
  id                String   @id @default(cuid())
  agentType         String
  actionId          String   // Reference to the action that was taken
  
  // User response
  accepted          Boolean? // null = no response yet
  userComment       String?  @db.Text
  
  // Learning data
  wasAccurate       Boolean? // Did the prediction/suggestion turn out to be correct?
  outcomeData       Json?    // Actual outcome vs. predicted
  
  createdAt         DateTime @default(now())
  respondedAt       DateTime?
  
  @@index([agentType])
  @@index([accepted])
  @@map("agent_feedback")
}

model AgentMetrics {
  id                String   @id @default(cuid())
  agentType         String
  
  // Performance metrics
  totalCycles       Int      @default(0)
  totalInsights     Int      @default(0)
  totalActions      Int      @default(0)
  avgExecutionTimeMs Int     @default(0)
  
  // Accuracy tracking
  totalFeedback     Int      @default(0)
  acceptedCount     Int      @default(0)
  rejectedCount     Int      @default(0)
  accuracyPercent   Decimal? @db.Decimal(5, 2)
  
  // Time period
  date              DateTime @default(now())
  periodType        String   @default("daily") // daily, weekly, monthly
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([agentType, date, periodType])
  @@index([agentType])
  @@index([date])
  @@map("agent_metrics")
}

// ============================================================================
// PHASE 4: Big 4 Decision Intelligence & MLOps
// ============================================================================

// Financial Snapshot for Big 4 Analysis
model FinancialSnapshot {
  id                    String   @id @default(cuid())
  userId                String
  periodStart           DateTime
  periodEnd             DateTime
  
  // Cashflow Metrics (for Big 4 Analysis)
  netCashflow90d        Decimal  @db.Decimal(10, 2)
  cashflowTrendPercent  Decimal  @db.Decimal(5, 2)
  discretionaryVariability Decimal @db.Decimal(5, 2)
  burnRate              Decimal  @db.Decimal(10, 2)
  safetyMargin          Decimal  @db.Decimal(5, 2)
  
  // Risk Metrics
  cashBuffer            Decimal  @db.Decimal(10, 2)
  bufferMultiple        Decimal  @db.Decimal(5, 2) // vs monthly avg
  monthlyIncome         Decimal  @db.Decimal(10, 2)
  incomeStability       String   // "stable", "variable", "volatile"
  
  // Spending Breakdown
  totalExpenses90d      Decimal  @db.Decimal(10, 2)
  discretionarySpending Decimal  @db.Decimal(10, 2)
  fixedExpenses         Decimal  @db.Decimal(10, 2)
  
  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, periodEnd])
  @@index([userId])
  @@index([periodEnd])
  @@map("financial_snapshots")
}

// Big 4 Decision Analysis Results
model Big4Analysis {
  id            String   @id @default(cuid())
  userId        String
  snapshotId    String?  // Reference to FinancialSnapshot
  
  // Analysis Results (stored as structured JSON)
  cashflowDiagnosis    Json  // Section 1
  riskProjection       Json  // Section 2 (30/60/90 day)
  strategicWeakPoints  Json  // Section 3
  recommendations      Json  // Section 4 (Top 3)
  
  // Metadata
  analysisDate         DateTime @default(now())
  variant              String   @default("big4") // "big4" or "baseline"
  promptVersion        String   // Track prompt iterations
  
  // Quality Metrics
  confidenceScore      Decimal? @db.Decimal(5, 2)
  specificityScore     Decimal? @db.Decimal(5, 2)
  responseTimeMs       Int?
  
  // User Feedback
  userRating           Int?     // 1-5 stars
  wasHelpful           Boolean?
  wasActedUpon         Boolean?
  feedbackText         String?  @db.Text
  feedbackDate         DateTime?
  
  // Token Usage
  promptTokens         Int?
  completionTokens     Int?
  totalTokens          Int?
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([analysisDate])
  @@index([variant])
  @@map("big4_analyses")
}

// A/B Testing Experiments
model AIExperiment {
  id            String   @id @default(cuid())
  name          String
  description   String?  @db.Text
  status        String   // RUNNING, PAUSED, COMPLETED
  
  // Variants
  controlName   String   @default("baseline")
  variantName   String   @default("big4")
  controlPrompt String   @db.Text
  variantPrompt String   @db.Text
  
  // Configuration
  trafficSplit  Int      @default(50) // % to variant
  minSampleSize Int      @default(100)
  
  // Results
  winnerVariant String?  // "control", "variant", or null if ongoing
  significance  Decimal? @db.Decimal(5, 4) // p-value
  
  // Dates
  startDate     DateTime
  endDate       DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  results AIExperimentResult[]
  
  @@index([status])
  @@index([startDate])
  @@map("ai_experiments")
}

// A/B Test Results
model AIExperimentResult {
  id              String   @id @default(cuid())
  experimentId    String
  userId          String
  variant         String   // "control" or "variant"
  
  // Request/Response Data
  requestData     Json
  responseData    Json
  responseTimeMs  Int
  
  // User Feedback
  userRating      Int?     // 1-5 stars
  wasHelpful      Boolean?
  wasActedUpon    Boolean?
  feedbackText    String?  @db.Text
  
  // Quality Metrics
  confidence      Decimal? @db.Decimal(5, 2)
  specificity     Decimal? @db.Decimal(5, 2)
  
  timestamp       DateTime @default(now())
  
  experiment AIExperiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  
  @@index([experimentId])
  @@index([userId])
  @@index([variant])
  @@index([timestamp])
  @@map("ai_experiment_results")
}

// AI Quality Metrics (Daily Aggregates)
model AIQualityMetrics {
  id                     String   @id @default(cuid())
  date                   DateTime @db.Date
  variant                String   // "big4" or "baseline"
  
  // Performance
  avgResponseTimeMs      Int
  p95ResponseTimeMs      Int
  totalRequests          Int
  errorCount             Int
  errorRate              Decimal  @db.Decimal(5, 2)
  
  // Quality
  avgUserRating          Decimal? @db.Decimal(3, 2)
  totalRatings           Int      @default(0)
  actionTakenRate        Decimal? @db.Decimal(5, 2)
  avgSpecificity         Decimal? @db.Decimal(5, 2)
  avgConfidence          Decimal? @db.Decimal(5, 2)
  
  // Token Usage
  avgPromptTokens        Int
  avgCompletionTokens    Int
  totalTokens            BigInt
  
  // Drift Detection
  uniquePatternsDetected Int
  anomalyScore           Decimal? @db.Decimal(5, 2)
  
  createdAt              DateTime @default(now())
  
  @@unique([date, variant])
  @@index([date])
  @@index([variant])
  @@map("ai_quality_metrics")
}

